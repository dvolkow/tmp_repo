# Оптимизация проверки задач для Linux* курсов

Отчет по семестровой практике 

Руководитель: *Марк Заславский*

Студент: *Даниил Волков*

Репозиторий: https://github.com/OSLL/mooc-lp-optimization

## Задачи и цели

Главную цель проекта можно охарактеризовать так -- усовершенствование проверяющей системы для курсов Stepic'a, посвященных программированию под Linux. Достижение этих целей требует решения таких задач:

- Оптимизация образов виртуальных машин (в первую очередь по объему).  

- Ускорение проверки решений (для некоторых заданий полное время проверки исчисляется минутами).

- Архитектурное разделение проверяющей системы и сценариев проверки отдельных заданий (проверяющая система не должна содержать решений проверяемых заданий).

Эти задачи были сформулированы руководителем с самого начала проекта. В дальнейшем, мы добавили в повестку ещё несколько требующих внимания более мелких вопросов:

- Профилирование проверки решений

- Автоматизация тестирования и непрерывная интеграция.

В первую очередь желание оптимизировать проверку задач вызвано реально существующей проблемой довольно длительного ожидания онлайн-проверки некоторых задач (конкретно курса [Разработка модулей ядра Linux](https://stepik.org/course/2051/syllabus)). Потенциальное сокращение времени проверки избавит пользователей от утомительного ожидания вердикта. Также, архитектурные усовершенствования призваны облегчить труд составителей задач и курсов. Для написания сценариев проверки отдельных заданий не должно быть необходимо модифицировать проверяющую систему, быть знакомым с принципами её работы и строением. Кроме того, сама проверяющая система содержит несколько откровенно неудачных архитектурных решений, которые мне было предложено решить в качестве первой задачи, заодно и для знакомства с самой системой.

## Организация работы

Каждый понедельник я и Марк либо встречаемся в БЦ "Таймс" (чаще), либо созваниваемся в slack\zoom (реже). Обсуждаются текущие наработки и намечаемся план дальнейших действий. Помимо этого, мы контактируем и в другое время в slack, если надо решить какие-то горячие вопросы. Используется и электронная почта, например для отправки протоколов встречи (список вопросов).

## Прогресс

К настоящему моменту удалось осуществить следующее.

- [Избавление от ```checker_pathes.rb```](https://github.com/OSLL/mooc-lp-optimization/issues/1). В первоначальном состоянии репозиторий содержал этот файл, в котором описывалось, какие задачи\сценарии проверки содержит проверяющая система, и их идентификаторы. Нужно было разработать стандарный формат именования сценариев проверки для любых задач, и избавиться от необходимости вручную описывать то, какие задачи и какие идентификаторы существуют. [Pull-request решения этой проблемы](https://github.com/OSLL/mooc-lp-optimization/pull/6)

- [Профилирование](https://github.com/OSLL/mooc-lp-optimization/issues/3). Прежде чем заниматься оптимизацией, необходимо найти узкие места. Для этого также нужно создать некоторые инструменты. Такими инструментами явились обычные скрипты анализа логов, и визуализации. Первоначально был проанализирован весь процесс проверки, по итогам выявлена стадия, занимающая больщую часть проверки заданий -- старт виртуальной машины. Если для провайдера *Docker* дела обстояли более-менее сносно, то для *Libvirt* [картина была однозначной](https://github.com/OSLL/mooc-lp-optimization/blob/master/statistics/pdfs/libvirt_bar.pdf). Следующим шагом был анализ старта виртуалки c Libvirt. И на этом шаге также удалось [однозначно](https://github.com/OSLL/mooc-lp-optimization/blob/master/statistics/pdfs/vm_start_bar.pdf) определить главного потребителя временных ресурсов. Подробные результаты этой работы содержатся [здесь](https://github.com/OSLL/mooc-lp-optimization/tree/master/statistics).

- [Архитектурное разделение](https://github.com/OSLL/mooc-lp-optimization/issues/2). К сожалению, на данный момент [решение](https://github.com/OSLL/mooc-lp-optimization/pull/16) данной задачи ещё требует проверки (обзор кода Марком + интеграция), как и некоторые другие усовершенствования проверяющей системы.

- Также было написано некоторое количество скриптов, упрощающих тестирование изменений и профилирование (например, ```reinstall.sh``` в корне репозитория), однако я считаю эти достижения относительно второстепенными по сравнению с вышеперечисленным, поэтому ограничусь только упоминанием о них. 

## Проблемы и трудности

В ходе профилирования [удалось выявить главную проблему производительности](https://github.com/OSLL/mooc-lp-optimization/issues/8). Её решение сократит время проверки задач, требующих Libvirt для проверки, в несколько раз. Для её разрешения мне необходимо более детально ознакомиться с системой Libvirt и возможностями её тонкой настройки. 

Также, ещё не предпринимался эксперимент с образами для VM. Это также является одной и задач проекта, требующих разрешения (и анализа). Но на данном этапе она видится менее очередной по сравнению с сетевыми настройками Libvirt. Из результатов профилирования видится, что сокращение объема образа внесет довольно незначительный вклад в сокращение времени проверки, а значит, и заниматься им нужно только после разрешения "сетевой" проблемы Libvirt. 

В ходе работы возникали трудности на раннем этапе, когда я изучал новый для себя язык *Ruby*, но он оказался вовсе не таким сложным, как я представлял, и даже вполне удобным для написания сценариев. Разобраться в кодовой базе проекта было относительно несложно несмотря на наличие определенного числа неудачных решений.

## Технологии

С некоторыми используемыми технологиями проекта я был знаком до начала работы над ним, однако практика позволила вспомнить многие вещи даже о казалось бы знакомых инструментах (особенно хочется отметить **bash**).

Языки:
- Ruby (новый для меня язык)
- Bash
- Python (его использование относительно минимальное)
- R (исключительно в профилировании для визуализации и подсчета некоторых статистик)

Система контроля версий:
- Git (здесь я тоже научился многому для себя -- управление ветками, разрешение конфликтов и многое другое)

Виртуализация:
- Vagrant + провайдеры: Docker и Libvirt

Коммуникация:
- Slack
- Google Calendar
- Email

В ходе работы над решением проблем также изучаются такие вещи, как DHCP и подобные более специальные вещи.

## Перспективы

В дальнейшем система проверки решений Linux-курсов на Stepic сможет стать более автономной, не требующей наличия специальных тестов для работы, вся работа по обеспечению курсов тестами ложится на авторов курсов. Также, для авторов курса будут созданы более комфортные условия интеграции с проверяющей системой их задач, а для пользователей курсов успешное решение поставленных выше задач будет означать быструю проверку, не требующей такого длительного ожидания. Возможна дальнейшая универсализация проверяющей системы, на более широкий спектр курсов.
